# Object Storage and S3

## Объектное хранилище

**Объектное хранилище** (англ. object storage) — облачная система хранения данных произвольного формата. В хранилище записываются **объекты** — по сути, привычные нам файлы. У каждого объекта есть уникальный идентификатор (аналог имени файла) и метаданные (дополнительные сведения). Идентификатор помогает различать объекты, а в метаданных хранятся, например, дата создания и MD5-хеш.

**Идентификатор объекта** — это строка. Ее часто записывают как путь в файловой системе, используя символ `/` как разделитель. Например, `archive/2020/ivanov/x-ray.jpg`. Благодаря этому файловые браузеры при работе с объектами имитируют привычное нам дерево папок. В консоли управления Yandex Cloud тоже есть такая возможность — части пути называются папками. Но важно понимать: на самом деле иерархии в объектном хранилище нет, оно плоское. За счет плоскости достигается большая скорость поиска по сравнению с файловой системой.Внутри хранилища объекты группируются в **бакеты**. Это позволяет разделять данные разных проектов или пользователей. У каждого бакета в Yandex Cloud уникальное имя. Переименовать бакет нельзя, поэтому выбирайте имя для бакета с умом.

## Класс хранилища

Размер [оплаты](https://cloud.yandex.ru/docs/storage/pricing) за использование объектного хранилища зависит от количества данных, операций с ними и исходящего трафика. Первый гигабайт и первые десятки тысяч операций бесплатные.

Выбирайте **класс хранилища** — стандартное или холодное — в зависимости от количества данных и запросов к ним:

![](<../../../.gitbook/assets/изображение (4).png>)

Сервис Yandex Object Storage — **S3-совместимое хранилище**. Его API совместим с Simple Storage Service API (S3 API), который был создан компанией Amazon в 2006 году и де-факто стал стандартом облачного хранения данных. S3-совместимость позволяет использовать в Yandex Cloud популярные инструменты для работы с S3-протоколом: консольные клиенты S3cmd и AWS CLI, файловые браузеры Cyberduck и WinSCP, библиотеки (SDK) для Python и Java.

## Метаданные

Метаданные бывают **пользовательскими** (их имена и значения вы добавляете и меняете сами) и **системными** (их устанавливает сервис).

Например, дата создания или последнего изменения объекта, его размер, MD5-хеш — это системные метаданные. Их полный список вы найдете в [документации](https://cloud.yandex.ru/docs/storage/concepts/object#system-meta).

Пользовательские метаданные передаются в облачное хранилище при загрузке объекта в HTTP-заголовках запроса. Имена заголовков с пользовательскими метаданными при этом должны начинаться с префикса `x-amz-meta-`:

```
PUT /images/image0349.dat HTTP/1.1
Host: hospital.storage.yandexcloud.net
Content-Length: 1403256
Date: Sat, 20 Mar 2021 14:15:02 GMT
Authorization: *...*
x-amz-meta-Patient-Surname: Petrov
x-amz-meta-Patient-ID: 4536
*...* 
```

До загрузки вы можете указывать имена метаданных объекта и прописными, и строчными буквами (хоть ABC, хоть abc). Однако после загрузки в хранилище они станут строчными (только abc). Таким образом, хранилище посчитает метаданные с именами Patient-ID и patient-id одинаковыми.

## Управление доступом

В объектном хранилище Yandex Cloud для контроля доступа используются три независимых механизма:

* сервис управления доступом (IAM, Identity and Access Management) работает на уровне всего облака;
* список управления доступом (ACL, Access Control List) работает на уровне бакетов и объектов;
* политика доступа (Bucket Policy) задаёт условия доступа к бакетам и объектам.

### IAM

IAM проверяет все операции в Yandex Cloud и управляет доступом на основе ролей — набора разрешений, которые описывают допустимые операции. Если разрешения нет, сервис сообщит об ошибке.

Помните, что роли действуют и на вложенные ресурсы. Если вы дадите системной группе `allUsers` (все пользователи интернета) или `allAuthenticatedUsers` (все пользователи, прошедшие аутентификацию в Yandex Cloud) права доступа к облаку или каталогу с объектным хранилищем — пользователи получат доступ ко всем бакетам в нем.

### ACL

ACL — это тоже список разрешений на действия. Но в отличие от IAM, он распространяется не на всё облако, а только на объектное хранилище. С помощью ACL можно разрешить:

* операции чтения для объектов и бакетов (READ);
* операции записи, перезаписи и удаления объектов (WRITE);
* полный доступ к объектам и бакетам (FULL\_CONTROL).

Разрешения в ACL соответствуют ролям пользователей в сервисе IAM. Например, разрешение FULL\_CONTROL соответствует роли `admin`. ACL используется в объектном хранилище для S3-совместимости, а также чтобы быстро предоставлять доступ к объектам или бакетам.

С помощью ACL можно выдать разрешения пользователям Yandex Cloud, сервисному аккаунту и системным группам `allUsers` и `allAuthenticatedUsers`. Чтобы выдать разрешение, надо знать [идентификатор его получателя](https://cloud.yandex.ru/docs/storage/concepts/acl#accounts-ids).

Подробности об ACL вы найдете в [документации](https://cloud.yandex.ru/docs/storage/concepts/acl).

### Политика доступа

С помощью политики доступа настраиваются дополнительные условия действий с бакетами и объектами. Вы можете, например, запретить доступ к бакету из конкретного диапазона IP-адресов.Элементы политики доступа:

* **ресурс** — бакет, префикс (условный «путь» в идентификаторе объекта) или объект;
* **действие** — запрошенная операция над ресурсом;
* **результат** — запрет (Deny) или разрешение (Allow) действия;
* **пользователь** — тот, кто запрашивал выполнение операции;
* **условие** — случаи, когда политика действует;
* **принцип выбора** — включить или исключить пользователей.

Подробности о том, как настраивать политики доступа, вы найдете в [документации](https://cloud.yandex.ru/docs/storage/concepts/policy).

### Какой механизм контроля доступа выбрать

Это зависит от ситуации.

* **Проверка через IAM выполняется всегда.** Назначьте пользователям вашего хранилища соответствующие роли. Для несложных сценариев (когда вы хотите знать, что может делать в хранилище конкретный пользователь) этого зачастую достаточно.
* **Политика доступа управляет доступом по дополнительным критериям.** Выбирайте её, если вам важно, при каких условиях разрешаются действия с бакетом или объектами.
* **ACL позволяет дать доступ к объекту**. Это удобно, когда нет смысла продумывать целую систему контроля доступа или тратить время на прописывание политик. Но если объектов много — лучше выбирать IAM или политику доступа.

### Подписанные ссылки

Ещё одна возможность открыть доступ к объектному хранилищу для скачивания или загрузки объекта — механизм **подписанных ссылок** (pre-signed URL). С его помощью предоставляется временный (от нескольких секунд до семи дней) доступ к объекту или бакету.

Ссылка содержит:

* подпись, вычисленную на основе ключа доступа к каталогу и секретного ключа;
* описание действия, которое пользователь может выполнить в хранилище.

С помощью подписанных ссылок приложение может генерировать ссылки на объекты в хранилище (например, для пользователей, которые оплатили скачиваемый контент). Подробный алгоритм, как составить подписанные URL, вы найдете в [документации](https://cloud.yandex.ru/docs/storage/concepts/pre-signed-urls).

## Другие свойства S3 в Yandex Cloud

Storage так же поддерживает:

* Версионирование (по умолчанию отключено)
* Поддержка инструментов для резервного копирования вне бакета
* Управление жизненным циклом объектов в бакете (например, удалять через N дней или перемещать в холодное хранилище, тк за него платить меньше приходится, если не обращаемся к объектам часто)
